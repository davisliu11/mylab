#!/bin/bash

NEWDIR="/etc/webhost-apache2-preview"

if [ "$1" = "start" ] || [ "$1" = "restart" ]; then

	ulimit -n 5120
	echo "clearing old config if exists"
	
	test -d $NEWDIR && rm -rf $NEWDIR && mkdir -p $NEWDIR && echo && echo "Done." && echo

	echo "Making copy of Apache configuration"

	rsync -var /etc/apache2/ $NEWDIR/

	sed -i 's|/etc/apache2|'$NEWDIR'|' $NEWDIR/apache2.conf
	
	# Let's make the preview instance use less procs, its just a testing environment...
	sed -i "s/^[[:blank:]]*StartServers[[:blank:]]*.*/StartServers 5/" $NEWDIR/apache2.conf
	sed -i "s/^[[:blank:]]*MinSpareServers[[:blank:]]*.*/MinSpareServers 5/" $NEWDIR/apache2.conf
	sed -i "s/^[[:blank:]]*MaxSpareServers[[:blank:]]*.*/MaxSpareServers 10/" $NEWDIR/apache2.conf
	
	grep -c SharememPath $NEWDIR/apache2.conf > /dev/null || echo "SharememPath /var/lib/apache2/fcgid-webhost" >> $NEWDIR/apache2.conf

	# Make PHP 5.3 the default for .php files
	sed -i 's|AddType application/x-httpd-php .php|AddType application/x-httpd-webhost-php53 .php .php3 .php4 .php5 .phtml|' $NEWDIR/apache2.conf

	# Modify ports.conf
	sed -i 's/NameVirtualHost \*:80$/NameVirtualHost *:8080/' $NEWDIR"/ports.conf"
	sed -i 's/NameVirtualHost \*:85$/NameVirtualHost *:8585/' $NEWDIR"/ports.conf"
	sed -i 's/NameVirtualHost \*:443$/NameVirtualHost *:4433/' $NEWDIR"/ports.conf"
	sed -i 's/Listen 80$/Listen 8080/' $NEWDIR"/ports.conf"
	sed -i 's/Listen 85$/Listen 8585/' $NEWDIR"/ports.conf"
	sed -i 's/Listen 443$/Listen 4433/' $NEWDIR"/ports.conf"

	# Modify other config files
	find ${NEWDIR}/conf.d -type f -exec sed -i 's/:80/:8080/g' {} \;
	find ${NEWDIR}/sites-available -type f -exec sed -i 's/:80/:8080/g' {} \;

	find ${NEWDIR}/conf.d -type f -exec sed -i 's/:443/:4433/g' {} \;
	find ${NEWDIR}/sites-available -type f -exec sed -i 's/:443/:4433/g' {} \;

	sed -i 's|AddType application/x-httpd-php .php .php3 .php4 .php5 .phtml|AddType application/application/x-httpd-webhost-php53 .php .php3 .php4 .php5 .phtml|' ${NEWDIR}/mods-available/suphp.conf
	sed -i '/suPHP_AddHandler application\/x-httpd-php/d' ${NEWDIR}/mods-available/suphp.conf
	sed -i 's|suPHP_ConfigPath        \/etc\/php5\/cgi|suPHP_ConfigPath        \/etc\/webhost-php53-cgi\/cgi-default|g'  ${NEWDIR}/mods-available/suphp.conf

	grep -c  "PidFile /var/run/apache2.pid" /etc/apache2/apache2.conf > /dev/null && sed -i 's|PidFile /var/run/apache2.pid|PidFile ${APACHE_PID_FILE}|g' /etc/apache2/apache2.conf
	sed -i 's|/var/run/apache2.pid|/var/run/apache2.pid.webhost-preview|' ${NEWDIR}/envvars

	# Make a copy of all the includes
	echo -n "Making copy of site includes ... "

	if [ ! -d ${NEWDIR}/site-includes ]; then
		mkdir ${NEWDIR}/site-includes
	fi

	if [ -f ${NEWDIR}/conf.d/zz010_psa_httpd.conf ]; then
		for include in `grep ^Include ${NEWDIR}/conf.d/zz010_psa_httpd.conf | cut -d " " -f 2`; do
			domain=`echo $include | cut -d / -f 5`
			newinclude=${domain}.httpd.include

			cp $include ${NEWDIR}/site-includes/${newinclude}

			sed -i 's/:80/:8080/g' ${NEWDIR}/site-includes/${newinclude}
			sed -i 's/:443/:4433/g' ${NEWDIR}/site-includes/${newinclude}
			sed -i 's/AddHandler php-script .php/#AddHandler php-script .php/' ${NEWDIR}/site-includes/${newinclude}

			sed -i 's|^Include '$include'|Include '${NEWDIR}/site-includes/${newinclude}'|' ${NEWDIR}/conf.d/zz010_psa_httpd.conf
		done
	fi

	echo

	if [ "`iptables -L -n | grep 8080`" = "" ]; then
		iptables -I INPUT -p tcp --dport 8080 -j ACCEPT
	fi

	if [ "`iptables -L -n | grep 4433`" = "" ]; then
		iptables -I INPUT -p tcp --dport 4433 -j ACCEPT
	fi

	echo -n "Starting preview Apache ... "

	if [ -f /var/run/apache2.pid.webhost-preview ]; then
		kill `cat /var/run/apache2.pid.webhost-preview`
	else
		if [ "`lsof -i tcp:8080 | grep -c ""`" != "0" ]; then
			lsof -i tcp:8080 | grep ^apache | cut -d " " -f 2 | xargs kill
		fi
	fi
	. ${NEWDIR}/envvars
	/usr/sbin/apache2 -f /etc/webhost-apache2-preview/apache2.conf

	echo "done"

elif [ "$1" = "stop" ]; then
	echo -n "Stopping preview Apache ... "
	if [ -f /var/run/apache2.pid.webhost-preview ]; then
		kill `cat /var/run/apache2.pid.webhost-preview`
	else
		if [ "`lsof -i tcp:8080 | grep -c ""`" != "0" ]; then
			lsof -i tcp:8080 | grep ^apache | cut -d " " -f 2 | xargs kill
		fi
	fi
	echo "done"
fi
