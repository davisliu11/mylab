#!/bin/sh
#script should
# sanitize domain
# verify domain exists
# dynamically list confs available
# request user input for which conf should be used
# sanitize input
# verify conf exists
# verify if domain already has vhost.conf
# if it does, print it, ask user input for overwrite/append, else create new one
# reconfigure apache, check apache conf

. /home/wdsupport/sbin/_functions

OVERWRITE=0
APPEND=0
REMOVE=0

function printUsage() {
	echo "Usage: setconf domain -r -f -a"
	echo " -f: overwrite existing configuration (ignored if -a or -r used)"
	echo " -a: append to existing configuration (ignored if -r used)"
	echo " -r: remove existing configuration"
	echo ""
	echo " If parameters are used in conjunction precedence follows remove > append > overwrite."
	echo " For example, if using 'setconf domain -r -a' the configuration will be removed."
	exit
}

# Defines ARG array based on arguments
for var in "$@"; do
        case $var in
        "-?")
		printUsage
                ;;
        "-r")
                REMOVE=1
		OVERWRITE=0
		APPEND=0
		echo "Removing configuration!"
                ;;
        "-f")
		if [[ "$APPEND" == "0" && "$REMOVE" == "0" ]]; then
	                OVERWRITE=1
			echo "Overwriting existing conf, if any."
		fi
                ;;
        "-a")
		if [ "$REMOVE" == "0" ]; then
			OVERWRITE=0
	                APPEND=1
			echo "Appending to existing conf, if any (if -f also used, this script will append)."
		fi
                ;;
        *)
                # Load arguments into an array
                ARG[${#ARG[@]}]=$var
                ;;
        esac
done

element_count=${#ARG[@]}

if [ ! "$element_count" = "1" ]; then
	printUsage
fi

domain=${ARG[0]}

if [[ ! ${domain} =~ ^[a-zA-Z0-9.-]+$ ]]; then
	echo "Invalid Domain \"${domain}\""
	exit
fi

if [ ! -d "/var/www/vhosts/${domain}" ]; then
	echo "Domain \"${1}\" not found"
	exit
fi


CONFEXIST=0
if [[ -f "/var/www/vhosts/${domain}/conf/vhost.conf" || -f "/var/www/vhosts/${domain}/conf/vhost_ssl.conf" ]]; then
	CONFEXIST=1
fi

if [[ "$REMOVE" == "1" ]]; then
	if [ "$CONFEXIST" != "1" ]; then
		echo "Configuration doesn't exist. Not removing."
		exit
	else
	        echo "Current conf, incase you mistakenly used -r:"
	        if [ -f "/var/www/vhosts/${domain}/conf/vhost.conf" ]; then
	                echo "/var/www/vhosts/${domain}/conf/vhost.conf"
	                cat "/var/www/vhosts/${domain}/conf/vhost.conf"
	        fi
	        if [ -f "/var/www/vhosts/${domain}/conf/vhost_ssl.conf" ]; then
	                echo "/var/www/vhosts/${domain}/conf/vhost_ssl.conf"
        	        cat "/var/www/vhosts/${domain}/conf/vhost.conf"
	        fi

		rm -f /var/www/vhosts/${domain}/conf/vhost.conf
		rm -f /var/www/vhosts/${domain}/conf/vhost_ssl.conf
		echo "Reconfiguring apache to remove vhost.conf"
		/opt/psa/admin/sbin/websrvmng -w -v --reconfigure-vhost --vhost-name=${domain}
		APACHE=`verifyApache`
		if [ "$?" == "1" ]; then
			echo "After removing the configuration for this domain."
			echo "Apache configuration has an error."
			echo $APACHE
		fi
		exit
	fi
fi

# Before starting, verify apache syntax is correct
APACHE=`verifyApache`
if [ "$?" == "1" ]; then
	echo "There is an error in the Apache configuration."
	echo "Not going any further until the error is corrected."
	echo $APACHE
	exit
fi

# Check for PHP 5.3 support
if [ "`dpkg-query -W --showformat='${Status}\n' webhost-php53-cgi`" = "install ok installed" ]; then
	echo
	echo "### PHP 5.3 Support is now available ###"
	echo 
	echo -n "Do you want to use PHP 5.3? [Y/n]: "
	read USEPHP53
	echo

	if [ "$USEPHP53" = "" ] || [ "$USEPHP53" = "y" ] || [ "$USEPHP53" = "Y" ]; then
		USEPHP53="1"
	else
		USEPHP53="0"
	fi
fi

if [ "$USEPHP53" = "1" ]; then
	confdir="/etc/webhost-php53-cgi"
else
	confdir="/etc/php5"
fi

confs="`find $confdir -type d -name 'cgi-*' | sort`"
for conf in $confs; do
	CONF[${#CONF[@]}]=$conf
done

echo "Available config files: "
choose num in ${CONF[*]}
while [[ ! ${REPLY} =~ ^[0-9]{1,2}$ || $REPLY -ge ${#CONF[@]} ]]; do
        echo "Invalid reply \"${REPLY}\". Retry (Crtl +C to abort)"
	read REPLY
done

echo Using ${CONF[$REPLY]}
conf="${CONF[$REPLY]}"
echo $conf


if [[ "$CONFEXIST" == "1" && "$OVERWRITE" == "1" ]]; then
	echo "Configuration already exists."
	echo "OVERWRITING (-f used)!"
	echo "Current conf, incase you mistakenly used -f:"
	if [ -f "/var/www/vhosts/${domain}/conf/vhost.conf" ]; then
		echo "/var/www/vhosts/${domain}/conf/vhost.conf"
		cat "/var/www/vhosts/${domain}/conf/vhost.conf"
	fi
	if [ -f "/var/www/vhosts/${domain}/conf/vhost_ssl.conf" ]; then
		echo "/var/www/vhosts/${domain}/conf/vhost_ssl.conf"
		cat "/var/www/vhosts/${domain}/conf/vhost.conf"
	fi

	echo "Writing /var/www/vhosts/${domain}/conf/vhost.conf with $conf"
        echo -e "<IfModule mod_suphp.c>
	suPHP_ConfigPath $conf" > /var/www/vhosts/${domain}/conf/vhost.conf
	if [ "$USEPHP53" = "1" ]; then
		echo "	AddHandler application/x-httpd-webhost-php53 .php" >> /var/www/vhosts/${domain}/conf/vhost.conf
	fi
	echo "</IfModule>" >> /var/www/vhosts/${domain}/conf/vhost.conf

	ln -sf /var/www/vhosts/${domain}/conf/vhost.conf /var/www/vhosts/${domain}/conf/vhost_ssl.conf

elif [[ "$CONFEXIST" == "1" && "$APPEND" == "1" ]]; then
	echo "Appending existing configuration on /var/www/vhosts/${domain}/conf/vhost.conf with $conf"
        echo -e "<IfModule mod_suphp.c>
	suPHP_ConfigPath $conf" >> /var/www/vhosts/${domain}/conf/vhost.conf
	if [ "$USEPHP53" = "1" ]; then
		echo "	AddHandler application/x-httpd-webhost-php53 .php" >> /var/www/vhosts/${domain}/conf/vhost.conf
	fi
	echo "</IfModule>" >> /var/www/vhosts/${domain}/conf/vhost.conf

	ln -sf /var/www/vhosts/${domain}/conf/vhost.conf /var/www/vhosts/${domain}/conf/vhost_ssl.conf
	echo "Final configuration:"
	cat /var/www/vhosts/${domain}/conf/vhost.conf

elif [[ "$CONFEXIST" == "1" ]]; then
	echo "Configuration already exists."
	echo "Use -f to overwrite or -a to append."
	exit
else
	echo "Configuration doesn't exist. Creating new one."
        echo "Writing /var/www/vhosts/${domain}/conf/vhost.conf with $conf"
        echo -e "<IfModule mod_suphp.c>
	suPHP_ConfigPath $conf" > /var/www/vhosts/${domain}/conf/vhost.conf
	if [ "$USEPHP53" = "1" ]; then
		echo "	AddHandler application/x-httpd-webhost-php53 .php" >> /var/www/vhosts/${domain}/conf/vhost.conf
	fi
	echo "</IfModule>" >> /var/www/vhosts/${domain}/conf/vhost.conf

	ln -sf /var/www/vhosts/${domain}/conf/vhost.conf /var/www/vhosts/${domain}/conf/vhost_ssl.conf
fi

echo "Reconfiguring apache to include new vhost.conf"
/opt/psa/admin/sbin/websrvmng -w -v --reconfigure-vhost --vhost-name=${domain}

# Verify apache syntax is correct
APACHE=`verifyApache`
if [ "$?" == "1" ]; then
	echo "While this script was running, an error appeared in the Apache configuration."
	echo 
	echo "If the error is showing up on the domain you were working on, please remove"
	echo "the configuration using -r"
	echo $APACHE
	exit
fi

/opt/psa/admin/sbin/websrvmng -v --reconfigure-vhost --vhost-name=${domain}
