#!/bin/bash

# Ensure the user exists, if not, create - try uid 1000
if [[ "`grep -c webdrive /etc/passwd`" -eq 0 ]]; then
	if [ "`cat /etc/passwd | cut -d ':' -f 3 | egrep '1000$'`" == "" ]; then
		groupadd webdrive --gid 1000
		useradd webdrive --uid 1000 --gid 1000 -d /home/webdrive -s /bin/bash
	else
		groupadd webdrive 2>/dev/null
		useradd webdrive -g webdrive -d /home/webdrive -s /bin/bash
	fi
fi

# Remove lock on sudoers.fallback file, if exists
if [ -f "/opt/webhost/sudoers.fallback" ]; then
	chattr -i /opt/webhost/sudoers.fallback
fi

# Remove any existing apt-check
if [ "`crontab -l | grep -c 'apt-check'`" != "0" ]; then
	(crontab -l | grep -v 'apt-check') | crontab -
	rm -f /root/apt-check >/dev/null 2>/dev/null
	rm -f /opt/webhost/bin/apt-check >/dev/null 2>/dev/null
fi

# Always remove existing authorized_keys file
rm -f /home/webdrive/.ssh/authorized_keys >/dev/null 2>/dev/null
